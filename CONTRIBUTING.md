# Contributing to zodvex

Thank you for considering contributing to zodvex! We appreciate your help in making this library better.

## Code of Conduct

This project and everyone participating in it is governed by our Code of Conduct. By participating, you are expected to uphold this code.

## How Can I Contribute?

### Reporting Bugs

Before creating bug reports, please check existing issues. When creating a bug report, include:

- **Clear, descriptive title**
- **Exact steps to reproduce** the problem
- **Specific examples** to demonstrate the steps
- **Observed behavior** vs **expected behavior**
- **Code samples** and error messages
- **Version information**: Node.js, Bun, Zod, Convex, and zodvex versions

### Suggesting Enhancements

Enhancement suggestions are tracked as GitHub issues. Include:

- **Clear, descriptive title**
- **Detailed description** of the suggested enhancement
- **Specific examples** demonstrating the feature
- **Current behavior** vs **expected behavior**
- **Why this would be useful** to zodvex users

### Pull Requests

1. Fork the repo and create your branch from `main`
2. If you've added code, add tests
3. If you've changed APIs, update the documentation
4. Ensure the test suite passes (`bun test`)
5. Make sure your code follows the existing style (`bun run lint`)
6. Issue that pull request!

## Development Setup

1. **Fork and clone** the repository
2. **Install dependencies**:
   ```bash
   bun install
   ```
3. **Run tests**:
   ```bash
   bun test
   ```
4. **Build the package**:
   ```bash
   bun run build
   ```

## Project Structure

```
zodvex/
â”œâ”€â”€ src/              # Source code
â”‚   â”œâ”€â”€ builders.ts       # Public API: builder pattern (zQueryBuilder, etc.)
â”‚   â”œâ”€â”€ custom.ts         # Public API: custom builders with context injection
â”‚   â”œâ”€â”€ wrappers.ts       # Internal: wrapper implementations (used by builders)
â”‚   â”œâ”€â”€ mapping.ts        # Core: Zod â†’ Convex validator conversion
â”‚   â”œâ”€â”€ codec.ts          # Core: encode/decode (Date â†” timestamp, etc.)
â”‚   â”œâ”€â”€ tables.ts         # Public API: zodTable for schema definitions
â”‚   â”œâ”€â”€ ids.ts            # Public API: zid() for Convex IDs
â”‚   â”œâ”€â”€ types.ts          # Type definitions and utilities
â”‚   â”œâ”€â”€ utils.ts          # Utility functions
â”‚   â””â”€â”€ index.ts          # Public API exports
â”œâ”€â”€ __tests__/        # Test suite
â”‚   â”œâ”€â”€ _generated/       # Mock Convex server types for tests
â”‚   â”œâ”€â”€ *.test.ts         # Runtime tests (Bun test runner)
â”‚   â””â”€â”€ *.test-d.ts       # Type-level tests (Vitest typecheck)
â”œâ”€â”€ test-utils/       # Test helpers and mocks
â”œâ”€â”€ typechecks/       # Additional type-level tests
â”œâ”€â”€ convex/           # Mock Convex environment for tests
â”œâ”€â”€ examples/         # Copy-paste ready code samples
â””â”€â”€ dist/             # Built output (generated by tsup)
```

## Public vs Internal APIs

**Public APIs** (exported from `src/index.ts`):
- `zQueryBuilder`, `zMutationBuilder`, `zActionBuilder` - Function builders
- `zCustomQueryBuilder`, `zCustomMutationBuilder`, `zCustomActionBuilder` - Custom context builders
- `zodTable`, `zid`, `zodToConvex`, `zodToConvexFields` - Schema utilities
- `convexCodec`, `pickShape`, `safePick` - Helper functions

**Internal APIs** (not exported):
- `zQuery`, `zMutation`, `zAction` - Wrapper implementations used by builders
- These are tested directly in `__tests__/wrappers.test.ts` but not part of the public API

## Testing

We use both **Bun's test runner** and **Vitest** for testing:

### Runtime Tests
```bash
bun test              # Run all tests with Bun
bun test mapping      # Run specific test file
```

### Type-level Tests
```bash
bun run test:types    # Run type-level tests with Vitest typecheck
```

### Coverage
```bash
bun run test:coverage # Generate coverage report
```

### Test Guidelines

- **Cover happy paths and edge cases**
- **Keep tests isolated** - no external dependencies
- **Follow existing patterns** - look at current tests for examples
- **Include type tests** for complex type transformations
- **Test both encoding and decoding** for codecs

## Coding Style

- **TypeScript** for all code
- **No semicolons**, single quotes, 2-space indentation (enforced by Biome)
- **Keep functions small and focused**
- **Document complex logic** with comments
- **Export types alongside implementations**
- **Prefer explicit over implicit**
- **Use descriptive names** - avoid abbreviations

### Linting & Formatting

We use [Biome](https://biomejs.dev/) for linting and formatting:

```bash
bun run lint          # Check for issues
bun run lint:fix      # Auto-fix issues
bun run format        # Format code
```

## Commit Messages

Use conventional commit format:

- Use **present tense** ("Add feature" not "Added feature")
- Use **imperative mood** ("Move cursor to..." not "Moves cursor to...")
- Limit first line to **72 characters**
- Reference issues liberally after the first line

**Examples:**
- `fix: handle nullable fields in nested objects`
- `feat: add support for Zod discriminated unions`
- `docs: update README with builder examples`
- `test: add coverage for Date codec edge cases`
- `refactor: simplify zodToConvex recursion`

## Architecture Principles

### Type Safety First
- Preserve Convex's optional/nullable semantics
- No `any` types in public APIs (internal use is acceptable if typed correctly)
- Comprehensive type tests for complex transformations

### Builder Pattern
- Builders are the primary public API
- They provide superior type inference over direct wrapper functions
- Follow Convex's native `{ args, handler, returns }` syntax

### Codec Design
- Encode: Zod-shaped data â†’ Convex JSON (Date â†’ timestamp, omit undefined)
- Decode: Convex JSON â†’ Zod-shaped data (timestamp â†’ Date)
- Always preserve schema structure

### Performance
- Minimize type recursion depth (avoid exponential type complexity)
- Cache validator conversions where possible
- Keep bundle size small - tree-shakeable exports

## Release Process

Releases are handled by maintainers:

1. Update version in `package.json`
2. Update `CHANGELOG.md` (if it exists)
3. Run full test suite: `bun test && bun run test:types`
4. Build: `bun run build`
5. Commit: `git commit -am "chore: release vX.Y.Z"`
6. Tag: `git tag vX.Y.Z`
7. Push: `git push && git push --tags`
8. Publish: `npm publish` (automated via CI preferred)

## Common Development Tasks

### Adding a New Zod Type Support

1. Add mapping logic in `src/mapping.ts`
2. Add encode/decode logic in `src/codec.ts` (if needed)
3. Add tests in `__tests__/mapping.test.ts` and `__tests__/codec.test.ts`
4. Add type tests in `typechecks/` if complex
5. Update README with examples

### Modifying the Builder API

1. Make changes in `src/builders.ts` and/or `src/custom.ts`
2. Update internal wrappers in `src/wrappers.ts` if needed
3. Add tests in `__tests__/` using the test mocks
4. Update `examples/queries.ts` with new patterns
5. Update README documentation

### Fixing a Type Inference Issue

1. Add a failing type test in `typechecks/`
2. Trace the type through the stack (builders â†’ wrappers â†’ mapping)
3. Fix the root cause (often in type definitions in `src/types.ts`)
4. Verify the type test passes
5. Add runtime tests to prevent regressions

## Questions?

Feel free to:
- Open an issue with your question
- Start a discussion in GitHub Discussions
- Reach out to maintainers

## License

By contributing, you agree that your contributions will be licensed under the MIT License.

---

Thank you for contributing! ðŸŽ‰
